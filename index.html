<!DOCTYPE html>
<html>
<head>
    <meta charset='UTF-8'/>
    <title>蒙特利尔餐厅地图</title>
    <link href="https://unpkg.com/mapbox-gl@1.13.1/dist/mapbox-gl.css" rel="stylesheet">
    <link href="https://unpkg.com/kepler.gl/umd/keplergl.min.css" rel="stylesheet">
    <style type="text/css">
        body {margin: 0; padding: 0; overflow: hidden;}
        #app {width: 100vw; height: 100vh;}
        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
            z-index: 1000;
        }
        .error {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            color: red;
            text-align: center;
            z-index: 1000;
        }
    </style>
    <!-- 基础依赖 -->
    <script src="https://unpkg.com/react@16.8.6/umd/react.production.min.js" type="text/javascript"></script>
    <script src="https://unpkg.com/react-dom@16.8.6/umd/react-dom.production.min.js" type="text/javascript"></script>
    <script src="https://unpkg.com/redux@3.7.2/dist/redux.min.js" type="text/javascript"></script>
    <script src="https://unpkg.com/react-redux@7.1.3/dist/react-redux.min.js" type="text/javascript"></script>
    
    <!-- Kepler.gl 相关依赖 -->
    <script src="https://unpkg.com/react-virtualized@9.21.0/dist/umd/react-virtualized.js" type="text/javascript"></script>
    <script src="https://unpkg.com/styled-components@4.1.3/dist/styled-components.min.js" type="text/javascript"></script>
    <script src="https://d1a3f4spazzrp4.cloudfront.net/kepler.gl/umd/react-palm.min.js" type="text/javascript"></script>
    <script src="https://unpkg.com/mapbox-gl@1.13.1/dist/mapbox-gl.js" type="text/javascript"></script>
    <script src="https://d1a3f4spazzrp4.cloudfront.net/kepler.gl/umd/keplergl.min.js" type="text/javascript"></script>
</head>
<body>
    <div id="app">
        <div class="loading">加载中...</div>
    </div>

    <script type="text/javascript">
        function checkDependencies() {
            const deps = {
                'React': window.React,
                'ReactDOM': window.ReactDOM,
                'Redux': window.Redux,
                'ReactRedux': window.ReactRedux,
                'ReactPalm': window.ReactPalm,
                'KeplerGl': window.KeplerGl,
                'mapboxgl': window.mapboxgl
            };

            for (const [name, obj] of Object.entries(deps)) {
                console.log(`检查依赖 ${name}:`, obj ? '已加载' : '未加载');
                if (!obj) {
                    console.error(`${name} 未能加载`);
                }
            }

            const missing = Object.entries(deps)
                .filter(([name, obj]) => !obj)
                .map(([name]) => name);

            if (missing.length > 0) {
                console.error('Missing dependencies:', missing);
                document.getElementById('app').innerHTML = `
                    <div class="error">
                        <h3>依赖库加载失败</h3>
                        <p>以下依赖未能正确加载：</p>
                        <ul>
                            ${missing.map(name => `<li>${name}</li>`).join('')}
                        </ul>
                        <p>请检查控制台获取详细信息</p>
                    </div>
                `;
                return false;
            }
            return true;
        }

        window.addEventListener('DOMContentLoaded', async () => {
            try {
                console.log('检查依赖...');
                if (!checkDependencies()) return;

                console.log('加载配置文件...');
                const configResponse = await fetch('kepler.gl.json');
                if (!configResponse.ok) throw new Error('配置文件加载失败');
                const config = await configResponse.json();

                console.log('加载数据文件...');
                const dataResponse = await fetch('yelp_montreal_restaurants_detailed_with_geotag.csv');
                if (!dataResponse.ok) throw new Error('数据文件加载失败');
                const csvData = await dataResponse.text();

                console.log('初始化 Redux store...');
                const {createStore, combineReducers, applyMiddleware} = Redux;
                const {taskMiddleware} = ReactPalm;
                const {Provider} = ReactRedux;

                const reducers = {
                    keplerGl: KeplerGl.keplerGlReducer
                };

                const store = createStore(
                    combineReducers(reducers),
                    {},
                    applyMiddleware(taskMiddleware)
                );

                console.log('创建应用组件...');
                const app = React.createElement(Provider, {store},
                    React.createElement(KeplerGl.KeplerGl, {
                        id: 'map',
                        width: window.innerWidth,
                        height: window.innerHeight,
                        mapboxApiAccessToken: 'pk.eyJIIjoibmlja3l1IiwiYSI6ImNsc2F1Y2F1YjE0Y2UyanA5Y2F1Y2F1YjE0Y2UifQ.u7hC26alykUtIToIcKF5Cw'
                    })
                );

                console.log('渲染应用...');
                ReactDOM.render(app, document.getElementById('app'));

                console.log('添加数据到地图...');
                const dataset = {
                    data: csvData,
                    info: {
                        id: 'restaurants',
                        label: '蒙特利尔餐厅'
                    }
                };

                store.dispatch(KeplerGl.addDataToMap({
                    datasets: [dataset],
                    config,
                    options: {
                        centerMap: true,
                        readOnly: true
                    }
                }));

                console.log('加载完成！');
            } catch (error) {
                console.error('发生错误:', error);
                document.getElementById('app').innerHTML = `
                    <div class="error">
                        <h3>加载失败</h3>
                        <p>错误信息: ${error.message}</p>
                        <p>请检查控制台获取详细信息</p>
                    </div>
                `;
            }
        });

        // 处理窗口大小变化
        window.addEventListener('resize', () => {
            const keplerGl = document.querySelector('.kepler-gl');
            if (keplerGl) {
                keplerGl.style.width = `${window.innerWidth}px`;
                keplerGl.style.height = `${window.innerHeight}px`;
            }
        });
    </script>
</body>
</html> 