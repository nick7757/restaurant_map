<!DOCTYPE html>
<html>
<head>
    <meta charset='UTF-8'/>
    <title>蒙特利尔餐厅地图</title>
    <!-- 样式依赖 -->
    <link href="https://unpkg.com/mapbox-gl@1.13.1/dist/mapbox-gl.css" rel="stylesheet">
    <link href="https://unpkg.com/kepler.gl@2.5.5/umd/keplergl.min.css" rel="stylesheet">
    <style type="text/css">
        body {margin: 0; padding: 0; overflow: hidden;}
        #app {width: 100vw; height: 100vh;}
        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
            z-index: 1000;
        }
        .error {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            color: red;
            text-align: center;
            z-index: 1000;
        }
    </style>
    <!-- 基础依赖 -->
    <script src="https://unpkg.com/react@16.8.6/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@16.8.6/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/redux@3.7.2/dist/redux.min.js"></script>
    <script src="https://unpkg.com/react-redux@7.1.3/dist/react-redux.min.js"></script>
    <script src="https://unpkg.com/react-virtualized@9.21.0/dist/umd/react-virtualized.js"></script>
    <script src="https://unpkg.com/styled-components@4.1.3/dist/styled-components.min.js"></script>
    
    <!-- Kepler.gl 相关依赖 -->
    <script src="https://unpkg.com/react-palm@3.1.2/dist/react-palm.min.js"></script>
    <script src="https://unpkg.com/mapbox-gl@1.13.1/dist/mapbox-gl.js"></script>
    <script src="https://unpkg.com/kepler.gl@2.5.5/umd/keplergl.min.js"></script>
</head>
<body>
    <div id="app">
        <div class="loading">加载中...</div>
    </div>

    <script>
        // 等待所有依赖加载完成
        function waitForDependencies() {
            return new Promise((resolve, reject) => {
                const checkInterval = setInterval(() => {
                    const deps = {
                        'React': window.React,
                        'ReactDOM': window.ReactDOM,
                        'Redux': window.Redux,
                        'ReactRedux': window.ReactRedux,
                        'ReactPalm': window.ReactPalm,
                        'KeplerGl': window.KeplerGl,
                        'mapboxgl': window.mapboxgl
                    };

                    const missing = Object.entries(deps)
                        .filter(([name, obj]) => !obj)
                        .map(([name]) => name);

                    if (missing.length === 0) {
                        clearInterval(checkInterval);
                        resolve();
                    } else {
                        console.log('等待依赖加载...', missing);
                    }
                }, 100);

                // 30秒后超时
                setTimeout(() => {
                    clearInterval(checkInterval);
                    reject(new Error('依赖加载超时'));
                }, 30000);
            });
        }

        async function initializeApp() {
            try {
                console.log('等待依赖加载...');
                await waitForDependencies();

                console.log('加载配置文件...');
                const configResponse = await fetch('kepler.gl.json');
                if (!configResponse.ok) throw new Error('配置文件加载失败');
                const config = await configResponse.json();

                console.log('加载数据文件...');
                const dataResponse = await fetch('yelp_montreal_restaurants_detailed_with_geotag.csv');
                if (!dataResponse.ok) throw new Error('数据文件加载失败');
                const csvData = await dataResponse.text();

                console.log('初始化 Redux store...');
                const {createStore, combineReducers, applyMiddleware} = Redux;
                const {taskMiddleware} = ReactPalm;
                const {Provider} = ReactRedux;

                const reducers = {
                    keplerGl: KeplerGl.keplerGlReducer
                };

                const store = createStore(
                    combineReducers(reducers),
                    {},
                    applyMiddleware(taskMiddleware)
                );

                console.log('创建应用组件...');
                const app = React.createElement(Provider, {store},
                    React.createElement(KeplerGl.KeplerGl, {
                        id: 'map',
                        width: window.innerWidth,
                        height: window.innerHeight,
                        mapboxApiAccessToken: 'pk.eyJIIjoibmlja3l1IiwiYSI6ImNsc2F1Y2F1YjE0Y2UyanA5Y2F1Y2F1YjE0Y2UifQ.u7hC26alykUtIToIcKF5Cw'
                    })
                );

                console.log('渲染应用...');
                ReactDOM.render(app, document.getElementById('app'));

                console.log('添加数据到地图...');
                const dataset = {
                    data: csvData,
                    info: {
                        id: 'restaurants',
                        label: '蒙特利尔餐厅'
                    }
                };

                store.dispatch(KeplerGl.addDataToMap({
                    datasets: [dataset],
                    config,
                    options: {
                        centerMap: true,
                        readOnly: true
                    }
                }));

                console.log('加载完成！');
            } catch (error) {
                console.error('发生错误:', error);
                document.getElementById('app').innerHTML = `
                    <div class="error">
                        <h3>加载失败</h3>
                        <p>错误信息: ${error.message}</p>
                        <p>请检查控制台获取详细信息</p>
                    </div>
                `;
            }
        }

        // 启动应用
        initializeApp();

        // 处理窗口大小变化
        window.addEventListener('resize', () => {
            const keplerGl = document.querySelector('.kepler-gl');
            if (keplerGl) {
                keplerGl.style.width = `${window.innerWidth}px`;
                keplerGl.style.height = `${window.innerHeight}px`;
            }
        });
    </script>
</body>
</html> 