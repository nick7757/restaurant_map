<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>蒙特利尔餐厅地图</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        #root {
            width: 100vw;
            height: 100vh;
        }
        .error {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: red;
            text-align: center;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
    </style>
    <script src="https://unpkg.com/react@16.8.6/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@16.8.6/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/redux@3.7.2/dist/redux.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-redux@5.1.1/dist/react-redux.min.js" crossorigin></script>
    <script src="https://unpkg.com/kepler.gl@2.5.5/umd/keplergl.min.js" crossorigin></script>
</head>
<body>
    <div id="root"></div>
    <script>
        function checkDependencies() {
            const deps = {
                'React': window.React,
                'ReactDOM': window.ReactDOM,
                'Redux': window.Redux,
                'ReactRedux': window.ReactRedux,
                'KeplerGl': window.KeplerGl
            };

            const missing = Object.entries(deps)
                .filter(([name, obj]) => !obj)
                .map(([name]) => name);

            if (missing.length > 0) {
                document.getElementById('root').innerHTML = `
                    <div class="error">
                        <h3>依赖库加载失败</h3>
                        <p>以下库未能正确加载：</p>
                        <ul>
                            ${missing.map(name => `<li>${name}</li>`).join('')}
                        </ul>
                    </div>
                `;
                return false;
            }
            return true;
        }

        function initializeMap() {
            if (!checkDependencies()) return;

            try {
                const mapboxToken = 'pk.eyJIIjoibmlja3l1IiwiYSI6ImNsc2F1Y2F1YjE0Y2UyanA5Y2F1Y2F1YjE0Y2UifQ.u7hC26alykUtIToIcKF5Cw';
                
                // 创建 Redux store
                const { createStore, combineReducers } = window.Redux;
                const { Provider } = window.ReactRedux;
                const { keplerGlReducer } = window.KeplerGl;
                
                const reducers = combineReducers({
                    keplerGl: keplerGlReducer
                });

                const store = createStore(reducers);

                // 创建应用组件
                const App = () => {
                    return window.React.createElement(Provider, { store },
                        window.React.createElement(window.KeplerGl.KeplerGl, {
                            id: 'map1',
                            mapboxApiAccessToken: mapboxToken,
                            width: window.innerWidth,
                            height: window.innerHeight
                        })
                    );
                };

                // 渲染应用
                window.ReactDOM.render(
                    window.React.createElement(App),
                    document.getElementById('root')
                );

                return store;
            } catch (error) {
                console.error('初始化失败:', error);
                document.getElementById('root').innerHTML = `
                    <div class="error">
                        <h3>初始化失败</h3>
                        <p>错误信息: ${error.message}</p>
                        <p>堆栈信息: ${error.stack}</p>
                    </div>
                `;
                return null;
            }
        }

        // 加载数据
        async function loadData(store) {
            if (!store) return;

            try {
                const response = await fetch('yelp_montreal_restaurants_detailed_with_geotag.csv');
                const data = await response.text();
                
                const datasets = {
                    info: {
                        label: '蒙特利尔餐厅',
                        id: 'restaurants'
                    },
                    data: data
                };

                const addDataToMapAction = window.KeplerGl.addDataToMap({
                    datasets: [datasets],
                    options: {
                        centerMap: true,
                        readOnly: true
                    }
                });

                store.dispatch(addDataToMapAction);
            } catch (error) {
                console.error('加载数据失败:', error);
                document.getElementById('root').innerHTML = `
                    <div class="error">
                        <h3>数据加载失败</h3>
                        <p>错误信息: ${error.message}</p>
                        <p>请确保数据文件存在且格式正确</p>
                    </div>
                `;
            }
        }

        // 初始化应用
        window.addEventListener('load', () => {
            console.log('开始初始化...');
            const store = initializeMap();
            if (store) {
                console.log('初始化成功，开始加载数据...');
                loadData(store);
            }
        });
    </script>
</body>
</html> 