<!DOCTYPE html>
<html>
<head>
    <meta charset='UTF-8'/>
    <title>蒙特利尔餐厅地图</title>
    <link href="https://d1a3f4spazzrp4.cloudfront.net/kepler.gl/umd/keplergl.min.css" rel="stylesheet">
    <style type="text/css">
        body {margin: 0; padding: 0; overflow: hidden;}
        #app {width: 100vw; height: 100vh;}
        .error {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            color: red;
            text-align: center;
        }
    </style>
</head>
<body>
    <div id="app"></div>
    <script src="https://unpkg.com/react@16.8.6/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@16.8.6/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/redux@3.7.2/dist/redux.min.js"></script>
    <script src="https://unpkg.com/react-redux@7.1.3/dist/react-redux.min.js"></script>
    <script src="https://unpkg.com/react-virtualized@9.21.0/dist/umd/react-virtualized.js"></script>
    <script src="https://unpkg.com/react-helmet@5.2.0/lib/react-helmet.min.js"></script>
    <script src="https://unpkg.com/react-palm@3.1.2/dist/react-palm.min.js"></script>
    <script src="https://d1a3f4spazzrp4.cloudfront.net/kepler.gl/umd/keplergl.min.js"></script>
    <script>
        const {createStore, combineReducers, applyMiddleware} = Redux;
        const {taskMiddleware} = ReactPalm;
        const {Provider} = ReactRedux;

        const reducers = {
            keplerGl: KeplerGl.keplerGlReducer
        };

        const store = createStore(
            combineReducers(reducers),
            {},
            applyMiddleware(taskMiddleware)
        );

        const MAPBOX_TOKEN = 'pk.eyJIIjoibmlja3l1IiwiYSI6ImNsc2F1Y2F1YjE0Y2UyanA5Y2F1Y2F1YjE0Y2UifQ.u7hC26alykUtIToIcKF5Cw';

        const app = (
            React.createElement(Provider, {store},
                React.createElement(KeplerGl.KeplerGl, {
                    id: 'map',
                    width: window.innerWidth,
                    height: window.innerHeight,
                    mapboxApiAccessToken: MAPBOX_TOKEN
                })
            )
        );

        const mountNode = document.getElementById('app');
        ReactDOM.render(app, mountNode);

        // 加载数据
        async function loadData() {
            try {
                const response = await fetch('yelp_montreal_restaurants_detailed_with_geotag.csv');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.text();

                const dataset = {
                    data: data,
                    info: {
                        id: 'restaurants',
                        label: '蒙特利尔餐厅'
                    }
                };

                const config = {
                    visState: {
                        filters: [],
                        layers: [{
                            id: 'point',
                            type: 'point',
                            config: {
                                dataId: 'restaurants',
                                columns: {
                                    lat: 'latitude',
                                    lng: 'longitude'
                                },
                                isVisible: true,
                                colorField: null,
                                color: [255, 0, 0]
                            }
                        }]
                    }
                };

                // 添加数据到地图
                const addDataToMapAction = KeplerGl.addDataToMap({
                    datasets: [dataset],
                    options: {
                        centerMap: true,
                        readOnly: true
                    },
                    config
                });

                store.dispatch(addDataToMapAction);
            } catch (error) {
                console.error('加载数据失败:', error);
                document.getElementById('app').innerHTML = `
                    <div class="error">
                        <h3>数据加载失败</h3>
                        <p>错误信息: ${error.message}</p>
                        <p>请检查网络连接和数据文件是否存在</p>
                    </div>
                `;
            }
        }

        // 页面加载完成后加载数据
        window.addEventListener('load', loadData);

        // 处理窗口大小变化
        window.addEventListener('resize', () => {
            const keplerGl = document.querySelector('.kepler-gl');
            if (keplerGl) {
                keplerGl.style.width = `${window.innerWidth}px`;
                keplerGl.style.height = `${window.innerHeight}px`;
            }
        });
    </script>
</body>
</html> 